<html>
<head>
  <title>Encrypted Text File</title>
  <style>
    #account, #field {
      width: 10em;
    }

    .good {
      outline: 1px solid lightgreen;
    }
    .bad {
      outline: 1px solid red;
    }

    input[type=text], input[type=password] {
      max-width: 10em;
    }

    table {
      border-collapse: collapse;
    }
    th,td {
      border: 1px solid black;
      vertical-align: text-top;
    }

    #bulk-operations {
      padding: 1em;
      border-right: 1px solid black;
      margin-right: 1em;
      max-width: 20em;
    }

    .column-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .row-container {
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    /* source: https://stackoverflow.com/a/6497462 */
    .horizontal-viewport-wrapper { overflow: scroll; width: 100%; height: 4em; }
    .horizontal-viewport { width: 200em; }
  </style>
<script type="text/javascript">/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, {
/******/ 				configurable: false,
/******/ 				enumerable: true,
/******/ 				get: getter
/******/ 			});
/******/ 		}
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = 2);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


Object.defineProperty(exports, "__esModule", {
  value: true
});
var _globals = {};
function globals() {
  return _globals;
}
exports.default = globals;

/***/ }),
/* 1 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


Object.defineProperty(exports, "__esModule", {
  value: true
});
function escapeRegExp(str) {
  // source: https://stackoverflow.com/a/6969486
  return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
}

function parseQuery(q) {
  var pattern = q.split(' ').map(escapeRegExp).join('.+');
  return new RegExp('^' + pattern, 'i');
}

exports.parseQuery = parseQuery;

/***/ }),
/* 2 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _globals = __webpack_require__(0);

var _globals2 = _interopRequireDefault(_globals);

var _download = __webpack_require__(3);

var _secret_store = __webpack_require__(8);

var _flash = __webpack_require__(4);

var _copy_to_clipboard = __webpack_require__(6);

var _copy_to_clipboard2 = _interopRequireDefault(_copy_to_clipboard);

var _encrypted_message = __webpack_require__(7);

var _encrypted_message2 = _interopRequireDefault(_encrypted_message);

var _query = __webpack_require__(1);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var globals = (0, _globals2.default)();
globals.window = window;
globals.document = document;

window.addEventListener('load', _download.takeSnapshot);

var decryptedJ = null;

var flasher;

function obliterate(x) {
  if (Array.isArray(x)) {
    while (x.length > 0) {
      obliterate(x[x.length - 1]);
      x.pop();
    }
  } else if ((typeof x === 'undefined' ? 'undefined' : _typeof(x)) === 'object') {
    Object.entries(x).forEach(function (_ref) {
      var _ref2 = _slicedToArray(_ref, 2),
          k = _ref2[0],
          v = _ref2[1];

      obliterate(v);
      delete x[k];
    });
  }
}

function only(xs) {
  if (xs.length !== 1) {
    throw 'expected 1 thing, got ' + xs.length + ': ' + JSON.stringify(xs);
  }
  return xs[0];
}

function updateView() {
  var _map = ['account', 'field'].map(function (f) {
    return (0, _query.parseQuery)(document.getElementById('copy-field--' + f).value);
  }),
      _map2 = _slicedToArray(_map, 2),
      accountRE = _map2[0],
      fieldRE = _map2[1];

  document.getElementById('view-holder').innerHTML = '';
  document.getElementById('view-holder').appendChild(j.filter(accountRE, fieldRE).buildView());
}

var j = new _secret_store.SecretStore({});
var decryptedJFingerprint = null;

function thereAreUnsavedChanges() {
  return j.nAccounts() > 0 && decryptedJFingerprint !== j.fingerprint();
}
function decrypt() {
  var em, plaintext, decryptedJ;
  return Promise.resolve().then(function () {
    em = _encrypted_message2.default.deserialize(document.getElementById('encrypted-message').innerText);
    return Promise.resolve().then(function () {
      return em.decrypt(document.getElementById('password').value);
    }).then(function (_resp) {
      plaintext = _resp;
    }).catch(function (err) {
      flasher.flash(document.getElementById('password'), 'red', '\n      Tried to decrypt the ciphertext in this HTML file, but password was incorrect.\n      (error: ' + err + ')\n    ');
      document.getElementById('password').focus();
      return;
    });
  }).then(function () {
    decryptedJ = new _secret_store.SecretStore(JSON.parse(plaintext));

    decryptedJFingerprint = decryptedJ.fingerprint();
    j.foldIn(decryptedJ);
    updateView();
    document.getElementById('copy-field--account').focus();
    flasher.flash(document.getElementById('decrypt-button'), 'lightgreen', '\n    Decrypted the ciphertext embedded in this HTML file, and merged it into working memory.\n  ');
  });
}
function copyPlaintext() {
  (0, _copy_to_clipboard2.default)(JSON.stringify(j.data, null, 2));
  flasher.flash(document.getElementById('copy-plaintext-button'), 'lightgreen', '\n    Copied entire working memory to clipboard, as JSON.\n  ');
}
function copyCiphertext() {
  (0, _copy_to_clipboard2.default)(JSON.stringify(_encrypted_message2.default.deserialize(document.getElementById('encrypted-message').innerText).toJSONFriendlyObject()));
}
function save() {
  var password, shouldContinue, oldJ, em;
  return Promise.resolve().then(function () {
    password = document.getElementById('password').value;
    shouldContinue = true;
    return Promise.resolve().then(function () {
      return _encrypted_message2.default.deserialize(document.getElementById('encrypted-message').innerText).decrypt(password);
    }).then(function (_resp) {
      oldJ = JSON.parse(_resp);
    }).catch(function (err) {
      if (err.name !== 'OperationError') {
        flasher.flash(document.getElementById('save-button'), 'red', '\n        Something REAL WEIRD happened while checking whether the password you entered matched the one for this file.\n        This should never happen.\n      ');
        throw err;
      }
      shouldContinue = confirm("You are about to download a passman file with a different password than the original one! Is that what you want?");
    });
  }).then(function () {
    if (!shouldContinue) {
      flasher.flash(document.getElementById('save-button'), 'red', 'Would have saved, but you aborted.');
    } else {

      if (password.length < 6) {
        shouldContinue = confirm('You password is only ' + password.length + ' characters long. I won\'t stop you, but please, MAKE REAL SURE THIS IS INTENTIONAL before saving.');
      }
      if (!shouldContinue) {
        flasher.flash(document.getElementById('save-button'), 'red', 'Would have saved, but you aborted.');
      } else {
        return Promise.resolve().then(function () {
          return _encrypted_message2.default.create(password, JSON.stringify(j.data));
        }).then(function (_resp) {
          em = _resp;

          (0, _download.downloadThisPageWithNewEncryptedMessage)(em);
          flasher.flash(document.getElementById('save-button'), 'lightgreen', '\n    Downloaded a clone of this HTML file, except the ciphertext encodes this page\'s current working memory.\n  ');
        });
      }
    }
  }).then(function () {});
}

function onEnter(element, callback) {
  element.addEventListener('keypress', function (event) {
    if (event.keyCode === 13) {
      callback(event);
    }
  });
}
function importCiphertext() {
  var file, html, doc, text, text, importedPlaintext, importedJ;
  return Promise.resolve().then(function () {
    file = document.getElementById('import-ciphertext-file').files[0];

    if (file === undefined) {
      flasher.flash(document.getElementById('import-ciphertext-file'), 'red', '\n      Tried to merge the ciphertext from another Passman file into working memory,\n      but no file was selected.\n    ');
    } else {
      return Promise.resolve().then(function () {
        return new Promise(function (resolve, reject) {
          var reader = new FileReader();
          reader.onload = function (e) {
            try {
              resolve(e.target.result);
            } catch (err) {
              $this.fileInput.value = [];
              reject(err);
            }
          };
          reader.readAsText(file);
        });
      }).then(function (_resp) {
        html = _resp;
        doc = flasher.doOrFlashRed(function () {
          doc = new DOMParser().parseFromString(html, 'text/html');
        }, document.getElementById('import-ciphertext-file'), "Tried to merge the ciphertext from another Passman file into working memory, but selected file couldn't be parsed as HTML.");
        text = flasher.doOrFlashRed(function () {
          doc.getElementById('encrypted-message').innerText;
        }, document.getElementById('import-ciphertext-file'), "Tried to merge the ciphertext from another Passman file into working memory, but there was no element with id='encrypted-message'.");
        text = flasher.doOrFlashRed(function () {
          _encrypted_message2.default.deserialize(text);
        }, document.getElementById('import-ciphertext-file'), "Tried to merge the ciphertext from another Passman file into working memory, but couldn't parse the ciphertext from it (this is extra weird -- maybe I made a non-backwards-compatible change to the encrypted-message format?).");
        importedPlaintext = flasher.awaitOrFlashRed(em.decrypt(document.getElementById('import-ciphertext-password').value), document.getElementById('import-ciphertext-password'), "Tried to merge the ciphertext from another Passman file into working memory, but password was wrong to decrypt the other file's ciphertext.");
        importedJ = flasher.doOrFlashRed(function () {
          JSON.parse(importedPlaintext);
        }, document.getElementById('import-ciphertext-password'), "Tried to merge the ciphertext from another Passman file into working memory, but failed to parse the JSON. (This is REALLY WEIRD.)");


        flasher.doOrFlashRed(function () {
          return j.foldIn(new _secret_store.SecretStore(importedJ));
        }, document.getElementById('import-ciphertext-button'), "Tried to merge the ciphertext from another Passman file into working memory, but the decrypted JSON object from the other file doesn't have the expected shape. (This is REALLY WEIRD.)");
        updateView();
        flasher.flash(document.getElementById('password'), 'lightgreen', '\n    Merged the ciphertext from another Passman file into working memory.\n  ');
      });
    }
  }).then(function () {});
}

function importPlaintext() {
  var importedJ = flasher.doOrFlashRed(function () {
    return JSON.parse(document.getElementById('import-plaintext-field').value);
  }, document.getElementById('import-plaintext-field'), "Tried to merge the 'Import JSON' field into working memory, but failed to parse the JSON.");
  flasher.doOrFlashRed(function () {
    return j.foldIn(new _secret_store.SecretStore(importedJ));
  }, document.getElementById('import-plaintext-button'), 'Tried to merge the \'Import JSON\' field into working memory, but the JSON object you pasted in doesn\'t have the expected shape. (It should be an exactly-two-level object whose leaf values are strings, like {"a": {"b": "c"}}, and not like {"a": {"b": ["c"]}} or {"a": {"b": 3}} or {"a": {"b": {}}}.)');
  updateView();
  flasher.flash(document.getElementById('import-plaintext-button'), 'lightgreen', '\n    Merged the JSON from the "import plaintext" field into working memory.\n  ');
}

function bulkImport() {
  var importedJ = new _secret_store.SecretStore(JSON.parse($('#bulk-import-field').value));
  j.foldIn(importedJ);
}

function setField() {
  var _map3 = ['account', 'field', 'value'].map(function (f) {
    return document.getElementById('set-field--' + f).value;
  }),
      _map4 = _slicedToArray(_map3, 3),
      account = _map4[0],
      field = _map4[1],
      value = _map4[2];

  j.set(account, field, value);
  updateView();
  flasher.flash(document.getElementById('set-field--value'), 'lightgreen', '\n    Set ' + account + '.' + field + '\n  ');
  document.getElementById('set-field--value').value = '';
}

window.addEventListener('load', function () {
  Object.entries({ 'decrypt-button': decrypt,
    'save-button': save,
    'copy-plaintext-button': copyPlaintext,
    'import-plaintext-button': importPlaintext,
    'import-ciphertext-button': importCiphertext,
    'set-field-button': setField }).forEach(function (_ref3) {
    var _ref4 = _slicedToArray(_ref3, 2),
        id = _ref4[0],
        clickCallback = _ref4[1];

    document.getElementById(id).addEventListener('click', clickCallback);
  });

  window.addEventListener('input', function (e) {
    if (e.target.classList.contains('query-field')) {
      updateView();
    }
  });
  window.addEventListener('click', function (e) {
    if (e.target.classList.contains('copy-button')) {
      var account = e.target.getAttribute('data-account');
      var field = e.target.getAttribute('data-field');
      (0, _copy_to_clipboard2.default)(j.get(account, field));
      flasher.flash(e.target, 'lightgreen', '\n        Copied ' + field + ' for ' + account + ' to clipboard.\n      ');
    }
  });

  document.getElementById('password').focus();
  onEnter(document.getElementById('password'), function () {
    document.getElementById('decrypt-button').click();
  });
  onEnter(document.getElementById('set-field--value'), function () {
    document.getElementById('set-field-button').click();
  });

  window.onbeforeunload = function () {
    if (thereAreUnsavedChanges()) {
      return "There are unsaved changes. Consider saving them.";
    }
  };

  ['account', 'field'].forEach(function (f) {
    var el = document.getElementById('copy-field--' + f);
    onEnter(el, function () {
      document.getElementsByClassName('copy-button')[0].click();el.focus();
    });
  });
  updateView();

  flasher = new _flash.Flasher(document.getElementById('status'));
});

/***/ }),
/* 3 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.downloadThisPageWithNewEncryptedMessage = exports.takeSnapshot = undefined;

var _globals = __webpack_require__(0);

var _globals2 = _interopRequireDefault(_globals);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var globals = (0, _globals2.default)();

function download(filename, text) {
  // source: https://stackoverflow.com/a/18197511/8877656
  var pom = globals.document.createElement('a');
  pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  pom.setAttribute('download', filename);

  if (globals.document.createEvent) {
    var event = globals.document.createEvent('MouseEvents');
    event.initEvent('click', true, true);
    pom.dispatchEvent(event);
  } else {
    pom.click();
  }
}

var originalHTML = null;
function takeSnapshot() {
  originalHTML = globals.document.getElementsByTagName('html')[0].outerHTML;
}

function downloadThisPageWithNewEncryptedMessage(encryptedMessage) {
  var e = globals.document.createElement('html');
  e.innerHTML = originalHTML;
  e.getElementsByClassName('encrypted-message')[0].innerText = encryptedMessage.serialize();
  download('passman.html', e.outerHTML);
}

exports.takeSnapshot = takeSnapshot;
exports.downloadThisPageWithNewEncryptedMessage = downloadThisPageWithNewEncryptedMessage;

/***/ }),
/* 4 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Flasher = function () {
  function Flasher(statusElement) {
    _classCallCheck(this, Flasher);

    this.statusElement = statusElement;
  }

  _createClass(Flasher, [{
    key: 'flash',
    value: function flash(element, color, message) {
      var duration = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 500;

      var oldColor = element.style['outline'];
      element.style['outline'] = '5px solid ' + color;
      setTimeout(function () {
        if (oldColor === undefined) delete element.style['outline'];else element.style['outline'] = oldColor;
      }, duration);
      this.statusElement.innerText = message.trim();
    }
  }, {
    key: 'doOrFlashRed',
    value: function doOrFlashRed(f, element, message) {
      var duration = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 500;

      try {
        return f();
      } catch (err) {
        this.flash(element, 'red', message + ('\n(error: ' + err + ')'), duration);
        throw err;
      }
    }
  }, {
    key: 'awaitOrFlashRed',
    value: function awaitOrFlashRed(p, element, message) {
      var duration,
          _this = this,
          _arguments = arguments;

      duration = _arguments.length > 3 && _arguments[3] !== undefined ? _arguments[3] : 500;

      try {
        return p;
      } catch (err) {
        _this.flash(element, 'red', message + ('\n(error: ' + err + ')'), duration);
        throw err;
      }
    }
  }]);

  return Flasher;
}();

exports.Flasher = Flasher;

/***/ }),
/* 5 */,
/* 6 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


Object.defineProperty(exports, "__esModule", {
  value: true
});

var _globals = __webpack_require__(0);

var _globals2 = _interopRequireDefault(_globals);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var globals = (0, _globals2.default)();

function copyToClipboard(text) {
  // source: https://stackoverflow.com/a/30810322
  var textArea = globals.document.createElement("textarea");

  //
  // *** This styling is an extra step which is likely not required. ***
  //
  // Why is it here? To ensure:
  // 1. the element is able to have focus and selection.
  // 2. if element was to flash render it has minimal visual impact.
  // 3. less flakyness with selection and copying which **might** occur if
  //    the textarea element is not visible.
  //
  // The likelihood is the element won't even render, not even a flash,
  // so some of these are just precautions. However in IE the element
  // is visible whilst the popup box asking the user for permission for
  // the web page to copy to the clipboard.
  //

  // Place in top-left corner of screen regardless of scroll position.
  textArea.style.position = 'fixed';
  textArea.style.top = 0;
  textArea.style.left = 0;

  // Ensure it has a small width and height. Setting to 1px / 1em
  // doesn't work as this gives a negative w/h on some browsers.
  textArea.style.width = '2em';
  textArea.style.height = '2em';

  // We don't need padding, reducing the size if it does flash render.
  textArea.style.padding = 0;

  // Clean up any borders.
  textArea.style.border = 'none';
  textArea.style.outline = 'none';
  textArea.style.boxShadow = 'none';

  // Avoid flash of white box if rendered for any reason.
  textArea.style.background = 'transparent';

  textArea.value = text;

  globals.document.body.appendChild(textArea);

  textArea.select();

  try {
    var successful = globals.document.execCommand('copy');
    var msg = successful ? 'successful' : 'unsuccessful';
    console.log('Copying text command was ' + msg);
  } catch (err) {
    console.log('Oops, unable to copy');
  }

  globals.document.body.removeChild(textArea);
}

exports.default = copyToClipboard;

/***/ }),
/* 7 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _globals = __webpack_require__(0);

var _globals2 = _interopRequireDefault(_globals);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var globals = (0, _globals2.default)();

function pbkdf2(password, keyDerivationAlgorithm, encryptionAlgorithm, forEncryption) {
  var pwUtf8, pwHash, _temp;

  return Promise.resolve().then(function () {
    pwUtf8 = new TextEncoder().encode(password);
    return globals.window.crypto.subtle.digest('SHA-256', pwUtf8);
  }).then(function (_resp) {
    pwHash = _resp;
    return Promise.all([keyDerivationAlgorithm, globals.window.crypto.subtle.importKey('raw', pwHash, keyDerivationAlgorithm, false, ['deriveKey']), encryptionAlgorithm, false, [forEncryption ? 'encrypt' : 'decrypt']]);
  }).then(function (_resp) {
    _temp = _resp;

    return globals.window.crypto.subtle.deriveKey(_temp[0], _temp[1], _temp[2], _temp[3], _temp[4]);
  });
}

var typedAlgorithmFields = {
  'iv': function iv(a) {
    return Uint8Array.from(a);
  },
  'salt': function salt(a) {
    return Uint8Array.from(a);
  },
  'counter': function counter(a) {
    return Uint8Array.from(a);
  }
};
function algorithmToJSONFriendlyObject(algorithm) {
  var j = Object.assign({}, algorithm);
  Object.keys(typedAlgorithmFields).forEach(function (attr) {
    if (j[attr] !== undefined) {
      j[attr] = Array.from(j[attr]);
    }
  });
  return j;
}
function jsonFriendlyObjectToAlgorithm(j) {
  var algorithm = Object.assign({}, j);
  Object.entries(typedAlgorithmFields).forEach(function (_ref) {
    var _ref2 = _slicedToArray(_ref, 2),
        attr = _ref2[0],
        typify = _ref2[1];

    if (algorithm[attr] !== undefined) {
      algorithm[attr] = typify(algorithm[attr]);
    }
  });
  return algorithm;
}

var defaultOptions = {
  keyDerivationAlgorithm: { 'name': 'PBKDF2', 'hash': 'SHA-256', 'iterations': 100000 },
  encryptionAlgorithm: { 'name': 'AES-GCM', 'length': 256 }
};

var EncryptedMessage = function () {
  function EncryptedMessage(keyDerivationAlgorithm, encryptionAlgorithm, ciphertext) {
    _classCallCheck(this, EncryptedMessage);

    this.keyDerivationAlgorithm = keyDerivationAlgorithm;
    this.encryptionAlgorithm = encryptionAlgorithm;
    this.ciphertext = ciphertext;
  }

  _createClass(EncryptedMessage, [{
    key: 'toJSONFriendlyObject',
    value: function toJSONFriendlyObject() {
      return {
        keyDerivationAlgorithm: algorithmToJSONFriendlyObject(this.keyDerivationAlgorithm),
        encryptionAlgorithm: algorithmToJSONFriendlyObject(this.encryptionAlgorithm),
        ciphertext: Array.from(new Uint8Array(this.ciphertext))
      };
    }
  }, {
    key: 'serialize',
    value: function serialize() {
      return JSON.stringify(this.toJSONFriendlyObject());
    }
  }, {
    key: 'decrypt',
    value: function decrypt(password) {
      var key,
          ptUtf8,
          _this7 = this;

      return Promise.resolve().then(function () {
        return pbkdf2(password, _this7.keyDerivationAlgorithm, _this7.encryptionAlgorithm, false);
      }).then(function (_resp) {
        key = _resp;
        return globals.window.crypto.subtle.decrypt(_this7.encryptionAlgorithm, key, _this7.ciphertext);
      }).then(function (_resp) {
        ptUtf8 = _resp;

        return new TextDecoder().decode(ptUtf8);
      });
    }
  }], [{
    key: 'fromJSONFriendlyObject',
    value: function fromJSONFriendlyObject(j) {
      var keyDerivationAlgorithm = j.keyDerivationAlgorithm,
          encryptionAlgorithm = j.encryptionAlgorithm,
          ciphertext = j.ciphertext;

      if (keyDerivationAlgorithm === undefined || encryptionAlgorithm === undefined || ciphertext === undefined) {
        alert('malformed JSON-ized encrypted message');
      }
      keyDerivationAlgorithm = jsonFriendlyObjectToAlgorithm(keyDerivationAlgorithm);
      encryptionAlgorithm = jsonFriendlyObjectToAlgorithm(encryptionAlgorithm);
      ciphertext = new Uint8Array(ciphertext).buffer;
      return new EncryptedMessage(keyDerivationAlgorithm, encryptionAlgorithm, ciphertext);
    }
  }, {
    key: 'deserialize',
    value: function deserialize(s) {
      return EncryptedMessage.fromJSONFriendlyObject(JSON.parse(s));
    }
  }, {
    key: 'create',
    value: function create(password, plaintext, options) {
      var _options, keyDerivationAlgorithm, encryptionAlgorithm, key, ptUtf8, ciphertext;

      return Promise.resolve().then(function () {
        options = Object.assign({}, defaultOptions, options);
        _options = options;
        keyDerivationAlgorithm = _options.keyDerivationAlgorithm;
        encryptionAlgorithm = _options.encryptionAlgorithm;

        keyDerivationAlgorithm.salt = globals.window.crypto.getRandomValues(new Uint8Array(12));
        return pbkdf2(password, keyDerivationAlgorithm, encryptionAlgorithm, true);
      }).then(function (_resp) {
        key = _resp;
        ptUtf8 = new TextEncoder().encode(plaintext);


        encryptionAlgorithm.iv = globals.window.crypto.getRandomValues(new Uint8Array(12));
        return globals.window.crypto.subtle.encrypt(encryptionAlgorithm, key, ptUtf8);
      }).then(function (_resp) {
        ciphertext = _resp;


        return new EncryptedMessage(keyDerivationAlgorithm, encryptionAlgorithm, ciphertext);
      });
    }
  }]);

  return EncryptedMessage;
}();

exports.default = EncryptedMessage;

/***/ }),
/* 8 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SecretStore = exports.validate = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _globals = __webpack_require__(0);

var _globals2 = _interopRequireDefault(_globals);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var globals = (0, _globals2.default)();

function appendNewChild(parent, tagName) {
  var result = globals.document.createElement(tagName);
  parent.appendChild(result);
  return result;
}

function validate(data) {
  if ((typeof data === 'undefined' ? 'undefined' : _typeof(data)) !== 'object') throw 'not an object';
  Object.entries(data).forEach(function (_ref) {
    var _ref2 = _slicedToArray(_ref, 2),
        k = _ref2[0],
        sub = _ref2[1];

    if ((typeof sub === 'undefined' ? 'undefined' : _typeof(sub)) !== 'object') throw 'key ' + JSON.stringify(k) + ' maps to non-object';
    Object.entries(sub).forEach(function (_ref3) {
      var _ref4 = _slicedToArray(_ref3, 2),
          field = _ref4[0],
          value = _ref4[1];

      if (typeof value !== 'string') throw 'field ' + JSON.stringify(k) + '.' + JSON.stringify(field) + ' has type ' + (typeof value === 'undefined' ? 'undefined' : _typeof(value)) + ', not string';
    });
  });
}

var SecretStore = function () {
  function SecretStore(data) {
    _classCallCheck(this, SecretStore);

    validate(data);
    this.data = data;
  }

  _createClass(SecretStore, [{
    key: 'nAccounts',
    value: function nAccounts() {
      return Object.values(this.data).length;
    }
  }, {
    key: 'nFields',
    value: function nFields() {
      return [].concat.apply([], Object.values(this.data).map(function (v) {
        return Object.keys(v);
      })).length;
    }
  }, {
    key: 'fingerprint',
    value: function fingerprint() {
      return JSON.stringify(Object.entries(this.data).sort().map(function (_ref5) {
        var _ref6 = _slicedToArray(_ref5, 2),
            k = _ref6[0],
            v = _ref6[1];

        return [k, Object.entries(v).sort()];
      }));
    }
  }, {
    key: 'allFields',
    value: function allFields() {
      var result = [];
      Object.entries(this.data).sort().forEach(function (_ref7) {
        var _ref8 = _slicedToArray(_ref7, 2),
            account = _ref8[0],
            info = _ref8[1];

        Object.entries(info).sort().forEach(function (_ref9) {
          var _ref10 = _slicedToArray(_ref9, 2),
              field = _ref10[0],
              value = _ref10[1];

          result.push([account, field, value]);
        });
      });
      return result;
    }
  }, {
    key: 'filter',
    value: function filter(accountRE, fieldRE) {
      var result = new SecretStore({});
      this.allFields().filter(function (_ref11) {
        var _ref12 = _slicedToArray(_ref11, 3),
            a = _ref12[0],
            f = _ref12[1],
            v = _ref12[2];

        return accountRE.test(a) && fieldRE.test(f);
      }).forEach(function (_ref13) {
        var _ref14 = _slicedToArray(_ref13, 3),
            a = _ref14[0],
            f = _ref14[1],
            v = _ref14[2];

        return result.set(a, f, v);
      });
      return result;
    }
  }, {
    key: 'foldIn',
    value: function foldIn(other) {
      var _this = this;

      other.allFields().forEach(function (_ref15) {
        var _ref16 = _slicedToArray(_ref15, 3),
            a = _ref16[0],
            f = _ref16[1],
            v = _ref16[2];

        return _this.set(a, f, v);
      });
    }
  }, {
    key: 'get',
    value: function get(account, field) {
      if (this.data[account] === undefined) return undefined;
      return this.data[account][field];
    }
  }, {
    key: 'set',
    value: function set(account, field, value) {
      if (value === '') {
        delete this.data[account][field];
        if (Object.keys(this.data[account]).length === 0) {
          delete this.data[account];
        }
      } else {
        if (this.data[account] === undefined) this.data[account] = {};
        this.data[account][field] = value;
      }
    }
  }, {
    key: 'buildView',
    value: function buildView() {
      var result = appendNewChild(globals.document.getElementById('view-holder'), 'table');

      var headerRow = appendNewChild(result, 'tr');
      appendNewChild(headerRow, 'th').innerText = this.nAccounts() + ' accounts match';
      appendNewChild(headerRow, 'th').innerText = this.nFields() + ' fields match';

      Object.entries(this.data).forEach(function (_ref17) {
        var _ref18 = _slicedToArray(_ref17, 2),
            account = _ref18[0],
            info = _ref18[1];

        var tr = appendNewChild(result, 'tr');
        appendNewChild(tr, 'td').innerText = account;
        var dataCell = appendNewChild(tr, 'td');
        Object.keys(info).sort().forEach(function (field) {
          var copyButton = appendNewChild(dataCell, 'button');
          copyButton.classList.add('copy-button');
          copyButton.setAttribute('data-account', account);
          copyButton.setAttribute('data-field', field);
          copyButton.innerText = field;
          appendNewChild(dataCell, 'br');
        });
      });
      return result;
    }
  }]);

  return SecretStore;
}();

exports.validate = validate;
exports.SecretStore = SecretStore;

/***/ })
/******/ ]);</script></head>
<body>

<!-- adapted from: https://stackoverflow.com/a/6497462 -->
<div class="horizontal-viewport-wrapper">
  <div id="status" class="horizontal-viewport">
  </div>
</div>

<table>
  <tr>
    <td style="padding: 1em; border: 5px solid black; height: 1px; width: 50%">
      <input type="password" id="password" placeholder="decryption password" />
      <button id="decrypt-button">Decrypt</button>
      <button id="save-button">Save</button>
    </td>

    <td rowspan="3" style="padding: 1em; border: 5px solid black; height: 100%; width: 50%">
      <div id="view-holder"></div>
    </td>
  </tr>
  <tr>
    <td style="padding: 1em; border: 5px solid black; height: 100%">
      <strong>Query Working Memory</strong>
      <ul>
        <li>
          Filter working memory: <br />
          <input type="text" class="query-field" id="copy-field--account" placeholder="account" /><input type="text" class="query-field" id="copy-field--field" placeholder="field" />

          <ul>
            <li>(queries must match beginnings of account/field names)</li>
            <li>(Space means "1 or more characters", so e.g. "a z" would match "amazon")</li>
            <li>(hit Enter to copy first match)</li>
          </ul>
        </li>
        <li>
          <button id="copy-plaintext-button" class="unlocked-only">Copy Working Memory as JSON</button>
        </li>
      </ul>
    </td>
  </tr>
  <tr>
    <td style="padding: 1em; border: 5px solid black">
      <strong>Update Working Memory</strong>
      <ul>
        <li style="border: 1px solid black; margin-bottom: 1em">
          Set
          <input type="text" class="query-field" id="set-field--account" placeholder="account" /><input type="text" class="query-field" id="set-field--field" placeholder="field" />
          to
          <input type="password" id="set-field--value" placeholder="new value" />
          <button id="set-field-button">Set</button>
        </li>
        <li style="border: 1px solid black; margin-bottom: 1em">
          <button id="import-plaintext-button">Import JSON</button> by pasting it here:
          <input id="import-plaintext-field" type="password" />
        </li>
        <li style="border: 1px solid black; margin-bottom: 1em">
          <button id="import-ciphertext-button">Decrypt and Import</button> another Passman file: <br/>
          <input id="import-ciphertext-password" type="password" placeholder="decryption password" />
          <input id="import-ciphertext-file" type="file" />
        </li>
      </ul>
    </td>
  </tr>
</table>

<br />
<hr />
<br />

<details>
  <summary><strong>Help</strong></summary>

  <details style="margin: 0.5em; border-left: 1px solid black; padding-left: 0.5em">
    <summary>Tutorial</summary>
    TODO
  </details>

  <details style="margin: 0.5em; border-left: 1px solid black; padding-left: 0.5em">
    <summary>I can't recover my passwords!</summary>
    <p>
      If this web page isn't working for you, you can use
      <a href="https://github.com/speezepearson/passman/blob/master/recover.py">this Python script</a>
      to recover them: in a terminal, run <code>pip install cryptodomex &amp;&amp; python recover.py html &lt; &lt;this file&gt;</code>.
    </p>
    <p>
      If Cryptodome stopped being maintained or something: sorry, you'll have to roll up your sleeves and:
    </p>
    <ul>
      <li>UTF-8 encode your master password</li>
      <li>run that through SHA-256</li>
      <li>run that hash through PBKDF2 (with the parameters given by the encrypted payload's <code>keyDerivationAlgorithm</code>)</li>
      <li>use that key to decrypt the encrypted payload's <code>ciphertext</code> using the encrypted payload's <code>encryptionAlgorithm</code> (by default, AES-256 in Galois/Counter Mode).</li>
    </ul>
  </details>

  <details style="margin: 0.5em; border-left: 1px solid black; padding-left: 0.5em">
    <summary>Why does [UI feature] suck?</summary>
    Maybe one of:
    <ol>
      <li>I try hard to make sure none of your secrets end up anywhere the browser might cache them -- notably, the JavaScript console, and anywhere in the DOM. This is rather constraining.</li>
      <li>"Copy to clipboard" is only permitted as a direct result of a user action; no asynchronous copies are allowed. Unfortunately, the whole WebCrypto interface is asynchronous, so anything like "encrypt-and-copy" is impossible.</li>
    </ol>
  </details>
</details>


  <div hidden="" class="encrypted-message" id="encrypted-message">{"keyDerivationAlgorithm":{"name":"PBKDF2","hash":"SHA-256","iterations":100000,"salt":[124,133,52,131,223,62,209,148,76,80,33,113]},"encryptionAlgorithm":{"name":"AES-GCM","length":256,"iv":[173,82,22,20,145,17,210,253,236,225,153,9]},"ciphertext":[255,63,5,84,184,252,102,187,130,149,116,83,129,4,76,1,143,232,63,73,106,16,197,232,100,43,197,230,235,104,53,193,116,239,114,142,253,173,0,1,136,5,34,31,116,27,33,92,151,200,19,24,12,117,166,114,220,31,116,187,183,250,98,16,84,231,11,108,26,69,226,229,226,124,32,43,57,214,69,17,195,242,140,140,78,140,238,167,9,80,42,76,9,103,117,189,30,33,25,115,123,230,255,15,221,146,210,31,143,194,255,173,159,24,13,33,47,73,161,62,95,77,197,235,208,170,107,17,231,67,230,46,30,83,219,157,147,192,16,140,181,213,82,10,49,99,134,88,49,105,36,142,170,76,234,36,217,59,17,129,60,193,51,221,71,85,184,202,45,215,192,115,72,190,11,134,37,78,200,79,89,38,66,228,158,29,247,90,253,17,156,225,249,21,98,124,94,131,235,166,99,170,29,7,24,255,35,217,84,158,195,140,83,203,198,217,151,95,45,68,107,194,172,83,17,89,110,157,74,42,176,12,212,26,196,68,189,97,35,168,255,249,214,158,200,31,184,203,109,71,123,190,130,183,30,101,167,105,203,189,250,45,13,141,29,252,8,117,219,14,28,143,144,201,67,226,229,247,101,95,196,82,102,150,64,19,223,96,103,45,200,98,22,158,172,13,21,35,131,108,13,79,57,18,254,123,84,220,148,7,144,230,246,58,101,9,94,67,128,235,141,11,66,249,100,134,6,146,79,202,45,234,19,255,118,10,35,39,195,133,43,157,3,46,246,136,217,219,127,107,234,216,41,239,45,246,215,0,93,38,42,242,44,160,231,163,47,72,77,127,222,208,104,253,94,0,69,218,145,249,30,236,76,70,171,218,17,39,108,194,84,84,114,85,86,79,12,21,235,14,29,142,137,81,85,42,107,227,69,34,9,197,239,109,101,21,254,123,206,124,233,105,4,173,224,214,151,130,219,188,175,153,215,190,91,89,96,240,68,230,196,178,34,57,26,114,17,9,53,223,250,151,44,31,89,178,209,217,23,154,85,150,97,107,69,243,171,169,223,190,33,132,8,198,59,12,218,250,203,146,120,10,48,236,17,28,200,92,226,189,48,149,15,208,11,218,247,246,117,157,137,26,182,131,10,94,22,50,181,176,61,54,195,134,166,19,133,198,136,227,190,121,160,9,175,220,9,255,223,177,115,237,32,238,174,133,138,42,224,128,159,5,78,99,180,32,135,196,153,140,14,108,82,29,67,10,67,155,141,47,48,71,19,3,88,8,247,104,153,250,16,41,123,72,201,156,198,125,172,87,100,22,60,134,55,91,248,50,61,116,238,2,160,162,84,157,78,47,237,235,71,173,31,252,30,147,218,37,8,140,249,172,45,151,197,102,89,84,31,69,240,239,242,28,107,175,9,170,0,64,77,242,128,138,75,222,121,64,140,79,249,5,109,233,138,69,246,1,84,0,52,211,149,253,139,195,191,99,12,105,153,99,114,150,231,104,72,30,186,37,202,131,242,154,207,7,171,19,178,154,96,27,167,106,4,146,169,253,192,251,227,183,56,175,223,114,85,113,181,226,189,175,179,196,173,242,84,52,254,45,201,242,241,138,173,194,208,13,137,225,114,12,91,204,134,28,139,160,129,51,146,170,241,182,210,55,200,142,240,210,183,5,35,137,102,79,123,82,83,45,211,56,57,188,78,98,255,72,63,206,151,134,229,31,117,67,180,236,132,225,67,228,211,92,145,54,158,52,107,83,163,129,19,28,24,152,137,38,79,47,136,55,48,93,110,103,197,203,131,197,3,251,222,166,168,5,174,145,10,179,41,83,12,86,51,69,171,208,141,80,166,198,128,19,72,153,91,195,96,200,228,210,164,145,108,120,215,174,121,237,15,239,185,159,231,106,135,124,209,141,241,53,128,162,174,134,18,204,153,154,121,186,193,83,69,166,182,160,18,128,173,87,79,23,127,44,112,169]}</div>


</body>
</html>
